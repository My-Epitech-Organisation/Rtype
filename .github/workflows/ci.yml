name: R-Type Action

on: [push, pull_request]


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CACHE_KEY_PREFIX: v2

jobs:
  cancel-if-mirror:
    name: Cancel if repository is the mirror
    runs-on: ubuntu-latest
    outputs:
      should_cancel: ${{ steps.check-repo-url.outputs.should_cancel }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: check-repo-url
        name: Check repository URL
        run: |
          REPO_URL=$(git config --get remote.origin.url)

          extract_repo_path() {
            local url=$1
            url=${url#https://github.com/}
            url=${url#git@github.com:}
            url=${url%.git}
            echo "$url"
          }

          MIRROR_PATH=$REPO_PATH
          CURRENT_REPO_PATH=$(extract_repo_path "$REPO_URL")

          if [ "$CURRENT_REPO_PATH" = "$MIRROR_PATH" ]; then
            echo "Repository path matches the mirror path. Skipping further jobs."
            echo "should_cancel=true" >> "$GITHUB_OUTPUT"
          else
            echo "Repository path does not match the mirror path. Proceeding with other jobs."
            echo "should_cancel=false" >> "$GITHUB_OUTPUT"
          fi
  cache-check:
    name: "ðŸ” Cache Check"
    runs-on: ubuntu-latest
    needs: [cancel-if-mirror]
    outputs:
      cache-hit-linux: ${{ steps.cache-check-linux.outputs.cache-hit }}
      cache-key-linux: ${{ steps.cache-keys.outputs.linux }}
      cache-key-windows: ${{ steps.cache-keys.outputs.windows }}
      deps-hash: ${{ steps.cache-keys.outputs.hash }}
      branch-name: ${{ steps.cache-keys.outputs.branch }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate cache keys
        id: cache-keys
        run: |
          HASH=$(sha256sum vcpkg.json 2>/dev/null | cut -d' ' -f1 || echo "no-vcpkg")
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          BRANCH_SAFE=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9]/-/g' | cut -c1-50)
          echo "branch=${BRANCH_SAFE}" >> $GITHUB_OUTPUT

          echo "linux=${{ env.CACHE_KEY_PREFIX }}-Linux-installed-${HASH}" >> $GITHUB_OUTPUT
          echo "windows=${{ env.CACHE_KEY_PREFIX }}-Windows-installed-${HASH}" >> $GITHUB_OUTPUT

      - name: Check Linux vcpkg_installed cache
        id: cache-check-linux
        uses: actions/cache/restore@v4
        with:
          path: build/vcpkg_installed
          key: ${{ steps.cache-keys.outputs.linux }}
          lookup-only: true

      - name: Cache status summary
        run: |
          echo "### ðŸ“¦ Cache Status" >> $GITHUB_STEP_SUMMARY
          echo "**Hash:** \`${{ steps.cache-keys.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ steps.cache-check-linux.outputs.cache-hit == 'true' && 'âœ… HIT - skipping deps' || 'âŒ MISS - will build' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | â³ checked on Windows |" >> $GITHUB_STEP_SUMMARY

  lint:
    name: "ðŸ” Code Quality"
    runs-on: ubuntu-latest
    needs: [cache-check]
    steps:
      - uses: actions/checkout@v4

      - name: Install linting tools (clang-format 19)
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-format-19 clang-tidy-19 python3
          sudo ln -sf /usr/bin/clang-format-19 /usr/bin/clang-format
          sudo ln -sf /usr/bin/clang-tidy-19 /usr/bin/clang-tidy
          echo "Installed versions:"
          clang-format --version
          clang-tidy --version

      - name: Make quality script executable
        run: chmod +x scripts/run_quality_checks.sh

      - name: Run Code Quality Checks
        id: quality-checks
        run: |
          ./scripts/run_quality_checks.sh --verbose

      - name: Upload Quality Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: /tmp/rtype_quality_report.txt
          if-no-files-found: warn

      - name: Lint Summary
        if: always()
        run: |
          echo "### ðŸ” Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Script:** \`scripts/run_quality_checks.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.quality-checks.outcome == 'success' && 'âœ… All checks passed' || 'âŒ Issues found - pipeline blocked' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/rtype_quality_report.txt ]; then
            echo "#### Detailed Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/rtype_quality_report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** Run \`./scripts/run_quality_checks.sh --fix\` locally to auto-fix formatting issues" >> $GITHUB_STEP_SUMMARY

  deps-linux:
    name: "ðŸ“¦ Dependencies (Linux)"
    runs-on: ubuntu-latest
    needs: [cache-check, lint]
    if: needs.cache-check.outputs.cache-hit-linux != 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build cmake pkg-config \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libglu1-mesa-dev \
            libfreetype6-dev libflac-dev libogg-dev libvorbis-dev libopenal-dev \
            libxinerama-dev libxext-dev \
            autoconf autoconf-archive automake libtool libltdl-dev

      - name: Configure CMake (install vcpkg packages)
        run: |
          cmake --preset linux-release \
            -DBUILD_TESTS=ON -DBUILD_EXAMPLES=OFF \
            -DUSE_SFML=ON

      - name: Save vcpkg_installed to cache
        uses: actions/cache/save@v4
        with:
          path: build/vcpkg_installed
          key: ${{ needs.cache-check.outputs.cache-key-linux }}

      - name: Summary
        run: |
          echo "### ðŸ“¦ Dependencies (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Built and cached vcpkg_installed" >> $GITHUB_STEP_SUMMARY

  deps-windows:
    name: "ðŸ“¦ Dependencies (Windows)"
    runs-on: windows-latest
    needs: [cache-check, lint]
    outputs:
      cache-hit: ${{ steps.cache-check.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Check Windows cache
        id: cache-check
        uses: actions/cache/restore@v4
        with:
          path: build/vcpkg_installed
          key: ${{ needs.cache-check.outputs.cache-key-windows }}
          lookup-only: true

      - name: Install Ninja
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: choco install ninja -y

      - name: Setup MSVC Developer Command Prompt
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake (install vcpkg packages)
        if: steps.cache-check.outputs.cache-hit != 'true'
        shell: bash
        run: |
          cmake --preset windows-release \
            -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF \
            -DUSE_SFML=ON

      - name: Save vcpkg_installed to cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: build/vcpkg_installed
          key: ${{ needs.cache-check.outputs.cache-key-windows }}

      - name: Summary
        shell: bash
        run: |
          echo "### ðŸ“¦ Dependencies (Windows)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.cache-check.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache HIT - skipped build" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Built and cached vcpkg_installed" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: "ðŸ§ª Unit Tests (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    needs: [cache-check, deps-linux, deps-windows]
    if: always() && needs.cache-check.result == 'success' && ((needs.deps-linux.result == 'success' || needs.deps-linux.result == 'skipped') || (needs.deps-windows.result == 'success' || needs.deps-windows.result == 'skipped'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            preset: linux-release
            cache-key-output: cache-key-linux
            triplet: x64-linux
            coverage: true
          - os: windows-latest
            preset: windows-release
            cache-key-output: cache-key-windows
            triplet: x64-windows
            coverage: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build cmake pkg-config \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libglu1-mesa-dev \
            libfreetype6-dev libflac-dev libogg-dev libvorbis-dev libopenal-dev \
            libxinerama-dev libxext-dev \
            lcov jq libltdl-dev

      - name: Install Ninja (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ninja -y

      - name: Setup MSVC Developer Command Prompt
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Restore vcpkg_installed from cache
        uses: actions/cache/restore@v4
        with:
          path: build/vcpkg_installed
          key: ${{ needs.cache-check.outputs[matrix.cache-key-output] }}
          fail-on-cache-miss: true

      - name: Configure CMake
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DBUILD_TESTS=ON -DBUILD_EXAMPLES=OFF \
            -DUSE_SFML=ON

      - name: Build tests (Windows only)
        if: matrix.os == 'windows-latest'
        run: cmake --build --preset ${{ matrix.preset }} --target all

      - name: Run tests (Windows only)
        if: matrix.os == 'windows-latest'
        run: |
          cd build
          ctest --output-on-failure --timeout 300

      - name: Run Coverage Analysis (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          rm -rf build-coverage coverage || true
          chmod +x scripts/coverage.sh
          ./scripts/coverage.sh --html

      - name: Upload Coverage Report (Linux only)
        if: matrix.os == 'ubuntu-latest' && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/html/
            coverage/coverage.info
          if-no-files-found: warn

      - name: Test Summary
        if: always()
        shell: bash
        run: |
          echo "### ðŸ§ª Test Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ matrix.coverage }}" == "true" ]; then
            echo "#### Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage thresholds:** Lines â‰¥80%, Functions â‰¥80%, Branches â‰¥55%" >> $GITHUB_STEP_SUMMARY
            if [ -d coverage/html ]; then
              echo "**HTML Report:** [View Coverage Report](coverage/html/index.html)" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f coverage/coverage.info ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Coverage Summary (lcov)**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              lcov --summary coverage/coverage.info | sed -n '1,200p' >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Top missed files (by missed lines)**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              awk '/^SF:/{f=substr($0,4)} /^DA:/{split($0,a,","); hits[f]++; tot[f]++} END{for(f in tot) if (tot[f]-hits[f]>0) print tot[f]-hits[f],tot[f],f}' coverage/coverage.info | sort -rn | head -n 20 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "coverage/coverage.info not found in workspace" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          if [ -f build/Testing/Temporary/LastTest.log ]; then
            echo "#### Test Log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 build/Testing/Temporary/LastTest.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: "ðŸ”¨ Build (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    needs: [cache-check, test, deps-linux, deps-windows]
    if: always() && needs.test.result == 'success' && (needs.deps-windows.result == 'success' || needs.deps-windows.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            preset: linux-release
            cache-key-output: cache-key-linux
            triplet: x64-linux
          - os: windows-latest
            preset: windows-release
            cache-key-output: cache-key-windows
            triplet: x64-windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build cmake pkg-config \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libglu1-mesa-dev \
            libfreetype6-dev libflac-dev libogg-dev libvorbis-dev libopenal-dev \
            libxinerama-dev libxext-dev libltdl-dev

      - name: Install Ninja (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ninja -y

      - name: Setup MSVC Developer Command Prompt
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Restore vcpkg_installed from cache
        uses: actions/cache/restore@v4
        with:
          path: build/vcpkg_installed
          key: ${{ needs.cache-check.outputs[matrix.cache-key-output] }}
          fail-on-cache-miss: true

      - name: Configure CMake
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DBUILD_EXAMPLES=OFF \
            -DUSE_SFML=ON

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }} --target r-type_client r-type_server rtype-display-sfml rtype-graphic-background-asteroidsSpace rtype-graphic-background-lobby rtype-graphic-background-labs rtype-graphic-background-spatialStation rtype-graphic-background-meteorInside rtype-graphic-background-blackHole rtype-graphic-music-chillMusic rtype-graphic-music-battleMusic rtype-graphic-music-exploreMusic

      - name: Prepare Windows dist (exe + DLLs only)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p build/dist/client/plugins/background build/dist/client/plugins/music build/dist/server
          echo "Staging Windows client executable"
          if ! ls build/src/client/*.exe >/dev/null 2>&1; then
            echo "Error: No client executable found"
            exit 1
          fi
          cp -v build/src/client/*.exe build/dist/client/

          echo "Staging Display plugin to plugins/"
          if ! ls build/lib/display/SFML/*.dll >/dev/null 2>&1; then
            echo "âŒ Error: Display DLL not found at build/lib/display/SFML/"
            exit 1
          fi
          # Copy the display DLL(s) and ensure one is named display.dll for downstream validation
          cp -v build/lib/display/SFML/*.dll build/dist/client/plugins/
          # If the expected display.dll is not present, copy the first display DLL and name it display.dll
          if [ ! -f build/dist/client/plugins/display.dll ]; then
            FIRST_DLL=$(ls build/dist/client/plugins/*.dll | head -n1 || true)
            if [ -n "$FIRST_DLL" ]; then
              cp -v "$FIRST_DLL" build/dist/client/plugins/display.dll
              echo "âœ… Renamed $FIRST_DLL â†’ display.dll"
            fi
          fi
          echo "âœ… Copied display DLL(s) to plugins/"

          echo "Staging Background plugins to plugins/background/"
          if ! ls build/lib/background/**/*.dll >/dev/null 2>&1; then
            echo "âŒ Error: Background DLL not found at build/lib/background/"
            exit 1
          fi
          cp -v build/lib/background/**/*.dll build/dist/client/plugins/background/
          echo "âœ… Copied background DLL(s) to plugins/background/"

          echo "Staging Audio/Music plugins to plugins/music/"
          if ! ls build/lib/audio/**/*.dll >/dev/null 2>&1; then
            echo "âŒ Error: Audio DLL not found at build/lib/audio/"
            exit 1
          fi
          cp -v build/lib/audio/**/*.dll build/dist/client/plugins/music/
          echo "âœ… Copied audio DLL(s) to plugins/music/"

          echo "Staging vcpkg runtime dependencies to root"
          if ! ls build/vcpkg_installed/x64-windows/bin/*.dll >/dev/null 2>&1; then
            echo "Error: No vcpkg DLLs found for client"
            exit 1
          fi
          cp -v build/vcpkg_installed/x64-windows/bin/*.dll build/dist/client/
          echo "âœ… Client dist contents:" && find build/dist/client -type f | head -20

          echo ""
          echo "Staging Windows server executable"
          if ! ls build/src/server/*.exe >/dev/null 2>&1; then
            echo "Error: No server executable found"
            exit 1
          fi
          cp -v build/src/server/*.exe build/dist/server/

          echo "Staging server vcpkg dependencies"
          if ! ls build/vcpkg_installed/x64-windows/bin/*.dll >/dev/null 2>&1; then
            echo "Error: No vcpkg DLLs found for server"
            exit 1
          fi
          cp -v build/vcpkg_installed/x64-windows/bin/*.dll build/dist/server/
          echo "âœ… Server dist contents:" && ls -la build/dist/server/

      - name: Upload Client Artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: r-type_client-${{ matrix.os }}
          path: build/dist/client/
          if-no-files-found: warn

      - name: Upload Server Artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: r-type_server-${{ matrix.os }}
          path: build/dist/server/
          if-no-files-found: warn

      - name: Prepare Linux Client Distribution
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          mkdir -p build/dist/client/plugins/background build/dist/client/plugins/music
          echo "Staging Linux client executable"
          if ! cp build/src/client/r-type_client build/dist/client/; then
            echo "Error: Failed to copy client executable"
            exit 1
          fi

          echo "Staging Display plugin to plugins/"
          if ! ls build/lib/display/SFML/*.so >/dev/null 2>&1; then
            echo "âŒ Error: Display .so not found at build/lib/display/SFML/"
            exit 1
          fi
          cp -v build/lib/display/SFML/*.so build/dist/client/plugins/display.so
          echo "âœ… Copied display .so to plugins/"

          echo "Staging Background plugins to plugins/background/"
          if ! ls build/lib/background/**/*.so >/dev/null 2>&1; then
            echo "âŒ Error: Background .so not found at build/lib/background/"
            exit 1
          fi
          cp -v build/lib/background/**/*.so build/dist/client/plugins/background/
          echo "âœ… Copied background .so(s) to plugins/background/"

          echo "Staging Audio/Music plugins to plugins/music/"
          if ! ls build/lib/audio/**/*.so >/dev/null 2>&1; then
            echo "âŒ Error: Audio .so not found at build/lib/audio/"
            exit 1
          fi
          cp -v build/lib/audio/**/*.so build/dist/client/plugins/music/
          echo "âœ… Copied audio .so(s) to plugins/music/"

          echo "âœ… Client dist contents:" && find build/dist/client -type f

      - name: Upload Client Artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: r-type_client-${{ matrix.os }}
          path: build/dist/client/
          if-no-files-found: warn

      - name: Upload Server Artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: r-type_server-${{ matrix.os }}
          path: build/src/server/r-type_server
          if-no-files-found: warn

      - name: Build Summary
        shell: bash
        run: |
          echo "### ðŸ”¨ Build Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Built using cached dependencies" >> $GITHUB_STEP_SUMMARY

  call-release:
    needs: [build, test]
    if: always() && needs.build.result == 'success' && needs.test.result == 'success' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    uses: ./.github/workflows/release.yml
    permissions:
      contents: write
      pull-requests: write
    secrets: inherit
    with:
      source_run_id: ${{ github.run_id }}

  mirror:
    name: "ðŸªž Push to Epitech Mirror"
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate SSH key
        run: |
          if [ -z "${{ secrets.GIT_SSH_PRIVATE_KEY }}" ]; then
            echo "::warning::GIT_SSH_PRIVATE_KEY secret is not configured, skipping mirror"
            exit 0
          fi

      - name: Push to Epitech mirror
        uses: pixta-dev/repository-mirroring-action@v1.1.1
        with:
          target_repo_url: git@github.com:EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-3.git
          ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}
