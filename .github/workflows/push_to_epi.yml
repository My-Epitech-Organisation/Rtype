name: Push to Epitech

on:
  push:
    branches-ignore:
      - 'ga-ignore-*'
      - 'HEAD'

  pull_request:
    branches-ignore:
      - 'ga-ignore-*'
      - 'HEAD'

env:
  REPO_PATH: EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-3
  GITHUB_URL: git@github.com:EpitechPGE3-2025/G-CPP-500-NAN-5-2-rtype-3.git


jobs:
  cancel-if-mirror:
    name: Cancel if repository is the mirror
    runs-on: ubuntu-latest
    outputs:
      should_cancel: ${{ steps.check-repo-url.outputs.should_cancel }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: check-repo-url
        name: Check repository URL
        run: |
          REPO_URL=$(git config --get remote.origin.url)

          extract_repo_path() {
            local url=$1
            url=${url#https://github.com/}
            url=${url#git@github.com:}
            url=${url%.git}
            echo "$url"
          }

          MIRROR_PATH=$REPO_PATH
          CURRENT_REPO_PATH=$(extract_repo_path "$REPO_URL")

          if [ "$CURRENT_REPO_PATH" = "$MIRROR_PATH" ]; then
            echo "Repository path matches the mirror path. Skipping further jobs."
            echo "should_cancel=true" >> "$GITHUB_OUTPUT"
          else
            echo "Repository path does not match the mirror path. Proceeding with other jobs."
            echo "should_cancel=false" >> "$GITHUB_OUTPUT"
          fi

  push_to_mirror:
    name: Push to mirror repository
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.cancel-if-mirror.outputs.should_cancel == 'false'
    needs: [cancel-if-mirror]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Validate SSH key
        run: |
          if [ -z "${{ secrets.GIT_SSH_PRIVATE_KEY }}" ]; then
            echo "Error: GIT_SSH_PRIVATE_KEY secret is not configured"
            exit 1
          fi

      - name: Push to mirror repository
        uses: pixta-dev/repository-mirroring-action@v1.1.1
        with:
          target_repo_url: ${{ env.GITHUB_URL }}
          ssh_private_key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}