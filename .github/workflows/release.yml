name: ðŸš€ R-Type Release

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check branch for manual release
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.ref_name }}" != "main" ]; then
            echo "âŒ Manual releases can only be triggered from the main branch"
            echo "Current branch: ${{ github.ref_name }}"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest release
        id: latest_release
        run: |
          git fetch --tags --force

          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST_TAG"
          echo "All tags found:"
          git tag -l 'v*' | sort -V

      - name: Calculate next version
        id: version
        run: |
          LATEST_TAG="${{ steps.latest_release.outputs.latest_tag }}"
          BRANCH="${{ github.ref_name }}"
          EVENT_NAME="${{ github.event_name }}"

          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          echo "Current version: $MAJOR.$MINOR.$PATCH"
          echo "Branch: $BRANCH"
          echo "Event: $EVENT_NAME"

          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
            PRERELEASE=false
            TAG_SUFFIX="release - main"
          elif [ "$BRANCH" = "main" ]; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            PRERELEASE=true
            TAG_SUFFIX="main"
          elif [ "$BRANCH" = "dev" ]; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
            PRERELEASE=true
            TAG_SUFFIX="dev"
          else
            echo "Unsupported branch for release: $BRANCH"
            exit 1
          fi

          NEW_VERSION="v$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "tag_suffix=$TAG_SUFFIX" >> $GITHUB_OUTPUT
      - name: Download Linux client artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: ${{ github.ref_name }}
          name: r-type_client-ubuntu-latest
          path: ./artifacts

      - name: Download Windows client artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: ${{ github.ref_name }}
          name: r-type_client-windows-latest
          path: ./artifacts

      - name: Download Linux server artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: ${{ github.ref_name }}
          name: r-type_server-ubuntu-latest
          path: ./artifacts

      - name: Download Windows server artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: ${{ github.ref_name }}
          name: r-type_server-windows-latest
          path: ./artifacts

      - name: Validate downloaded artifacts
        run: |
          echo "ðŸ” Validating downloaded artifacts..."

          MISSING=0

          # Check for Linux client executable
          if [ ! -f "artifacts/r-type_client" ] && [ ! -d "artifacts/r-type_client-ubuntu-latest" ]; then
            echo "âŒ Missing Linux client artifact (expected: artifacts/r-type_client or artifacts/r-type_client-ubuntu-latest/)"
            MISSING=1
          fi

          # Check for Windows client directory
          if [ ! -d "artifacts/r-type_client-windows-latest" ]; then
            echo "âŒ Missing Windows client artifact (expected: artifacts/r-type_client-windows-latest/)"
            MISSING=1
          fi

          # Check for Linux server executable
          if [ ! -f "artifacts/r-type_server" ] && [ ! -d "artifacts/r-type_server-ubuntu-latest" ]; then
            echo "âŒ Missing Linux server artifact (expected: artifacts/r-type_server or artifacts/r-type_server-ubuntu-latest/)"
            MISSING=1
          fi

          # Check for Windows server directory
          if [ ! -d "artifacts/r-type_server-windows-latest" ]; then
            echo "âŒ Missing Windows server artifact (expected: artifacts/r-type_server-windows-latest/)"
            MISSING=1
          fi

          if [ "$MISSING" -ne 0 ]; then
            echo "âŒ One or more required artifacts are missing. This likely means the CI workflow failed to build or upload artifacts."
            echo "Please check the CI workflow run for this branch to ensure all builds completed successfully."
            exit 1
          fi

          echo "âœ… All required artifacts are present"

      - name: Extract and prepare release assets
        run: |
          mkdir -p release-assets

          if [ -f artifacts/r-type_client-ubuntu-latest.zip ]; then
            unzip artifacts/r-type_client-ubuntu-latest.zip -d release-assets/linux-client/
            echo "âœ… Extracted Linux client"
          fi

          if [ -f artifacts/r-type_client-windows-latest.zip ]; then
            unzip artifacts/r-type_client-windows-latest.zip -d release-assets/windows-client/
            echo "âœ… Extracted Windows client"
          fi

          if [ -f artifacts/r-type_server-ubuntu-latest.zip ]; then
            unzip artifacts/r-type_server-ubuntu-latest.zip -d release-assets/linux-server/
            echo "âœ… Extracted Linux server"
          fi

          if [ -f artifacts/r-type_server-windows-latest.zip ]; then
            unzip artifacts/r-type_server-windows-latest.zip -d release-assets/windows-server/
            echo "âœ… Extracted Windows server"
          fi

          echo ""
          echo "Release assets prepared:"
          find release-assets -type f | head -20

      - name: Check for new commits since last release
        id: check_commits
        run: |
          LATEST_TAG="${{ steps.latest_release.outputs.latest_tag }}"
          BRANCH="${{ github.ref_name }}"

          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "Current branch: $BRANCH"
          echo "Latest tag: $LATEST_TAG"

          if git rev-parse --verify "$LATEST_TAG" >/dev/null 2>&1; then
            echo "Latest tag commit: $(git rev-parse $LATEST_TAG)"
            NEW_COMMITS=$(git rev-list "${LATEST_TAG}"..HEAD --count)
            echo "New commits since ${LATEST_TAG}: ${NEW_COMMITS}"
          else
            echo "Latest tag not found (likely v0.0.0 default), counting all commits"
            NEW_COMMITS=$(git rev-list HEAD --count)
            echo "Total commits in repository: ${NEW_COMMITS}"
          fi

          if [ "${NEW_COMMITS}" -gt 0 ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "No new commits since last release, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Create release with auto-generated notes
        if: steps.check_commits.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: R-Type ${{ steps.version.outputs.new_version }} (${{ steps.version.outputs.tag_suffix }})
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: |
            release-assets/linux-client/*
            release-assets/windows-client/*
            release-assets/linux-server/*
            release-assets/windows-server/*