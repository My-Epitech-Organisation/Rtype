<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Type Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: var(--accent-color) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .card {
            background: var(--secondary-color) !important;
            border: 1px solid var(--accent-color) !important;
            color: #fff !important;
        }

        .card-body {
            padding: 1.5rem;
        }

        .metric-card {
            text-align: center;
            border-radius: 0.5rem;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--highlight-color);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 0.5rem;
        }

        .nav-tabs .nav-link {
            color: #aaa !important;
            border: none !important;
            border-bottom: 2px solid transparent !important;
        }

        .nav-tabs .nav-link.active {
            color: var(--highlight-color) !important;
            background: transparent !important;
            border-bottom: 2px solid var(--highlight-color) !important;
        }

        .btn-primary {
            background: var(--highlight-color) !important;
            border: none !important;
        }

        .btn-primary:hover {
            background: #d63a4f !important;
        }

        .table {
            color: #fff !important;
        }

        .table thead th {
            border-bottom: 2px solid var(--accent-color) !important;
            color: var(--highlight-color) !important;
        }

        .table tbody td {
            border-bottom: 1px solid var(--accent-color) !important;
        }

        .badge {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }

        .badge-online {
            background: #4ade80 !important;
            color: #000 !important;
        }

        .badge-offline {
            background: #ef4444 !important;
        }

        .modal-content {
            background: var(--secondary-color) !important;
        }

        .modal-header {
            border-bottom: 1px solid var(--accent-color) !important;
        }

        .form-control, .form-select {
            background: var(--primary-color) !important;
            border: 1px solid var(--accent-color) !important;
            color: #fff !important;
        }

        .form-control:focus, .form-select:focus {
            background: var(--primary-color) !important;
            border-color: var(--highlight-color) !important;
            color: #fff !important;
            box-shadow: 0 0 0 0.2rem rgba(233, 69, 96, 0.25);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid var(--accent-color);
            border-top: 3px solid var(--highlight-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }
    </style>
</head>
<body>
<div id="app">
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand">
            <strong>⚔️ R-Type Server Admin</strong>
        </span>
        <div class="navbar-text ms-auto">
            <small class="text-muted">Server Status: <span class="badge" :class="serverOnline ? 'badge-online' : 'badge-offline'">{{ serverOnline ? 'ONLINE' : 'OFFLINE' }}</span></small>
        </div>
    </div>
</nav>

<div class="container-fluid p-4">
    <div v-if="loading" class="loading">
        <div class="spinner"></div>
        <p class="mt-3">Loading dashboard...</p>
    </div>

    <div v-else>
        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ metrics.playerCount }}</div>
                        <div class="metric-label">Players Online</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ metrics.uptime }}s</div>
                        <div class="metric-label">Uptime</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ Math.floor(metrics.packetsReceived / 1000) }}k</div>
                        <div class="metric-label">Packets RX</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ metrics.tickOverruns }}</div>
                        <div class="metric-label" title="Number of times server loop exceeded target tick time">Tick Overruns ⓘ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ lobbies.length }}</div>
                        <div class="metric-label">Active Lobbies</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ Math.floor(metrics.packetsSent / 1000) }}k</div>
                        <div class="metric-label">Packets TX</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ metrics.totalConnections || 0 }}</div>
                        <div class="metric-label">Total Connections</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-value">{{ Math.floor((metrics.bytesReceived + metrics.bytesSent) / 1024 / 1024) }}MB</div>
                        <div class="metric-label">Total Traffic</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Player Count History</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="playerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Packets Received</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="packetRxChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Packet Loss %</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="packetLossChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Tick Overruns</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tickOverrunsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" href="#lobbies" role="tab" data-bs-toggle="tab">Lobbies</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#players" role="tab" data-bs-toggle="tab">Players</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#bans" role="tab" data-bs-toggle="tab">Bans</a>
            </li>
            <li class="nav-item ms-auto">
                <button class="btn btn-sm btn-warning" @click="resetMetrics">Reset Metrics</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Lobbies Tab -->
            <div id="lobbies" class="tab-pane fade show active">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Active Lobbies</h5>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createLobbyModal">Create Lobby</button>
                    </div>
                    <div class="card-body">
                        <div v-if="lobbies.length === 0" class="empty-state">
                            No active lobbies
                        </div>
                        <table v-else class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Players</th>
                                    <th>Difficulty</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="lobby in lobbies" :key="lobby.code">
                                    <td><code>{{ lobby.code }}</code></td>
                                    <td>{{ lobby.playerCount }}/{{ lobby.maxPlayers }}</td>
                                    <td>{{ lobby.difficulty }}</td>
                                    <td><span class="badge" :class="lobby.isPublic ? 'bg-info' : 'bg-secondary'">{{ lobby.isPublic ? 'Public' : 'Private' }}</span></td>
                                    <td><span class="badge" :class="lobby.active ? 'badge-online' : 'badge-offline'">{{ lobby.active ? 'Active' : 'Idle' }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" @click="deleteLobby(lobby.code)" :disabled="lobby.playerCount > 0">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Players Tab -->
            <div id="players" class="tab-pane fade">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Connected Players</h5>
                    </div>
                    <div class="card-body">
                        <div v-if="players.length === 0" class="empty-state">
                            No connected players
                        </div>
                        <table v-else class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Lobby</th>
                                    <th>IP</th>
                                    <th>PING</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="player in players" :key="player.id">
                                    <td>#{{ player.id }}</td>
                                    <td><code>{{ player.lobbyCode }}</code></td>
                                    <td><code>{{ player.ip }}</code></td>
                                    <td>{{ player.ping }}ms</td>
                                    <td><span class="badge" :class="player.isReady ? 'badge-online' : 'badge-offline'">{{ player.isReady ? 'Ready' : 'Waiting' }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-warning me-2" @click="kickPlayer(player.id)">Kick</button>
                                        <button class="btn btn-sm btn-danger" @click="banPlayer(player)">Ban</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bans Tab -->
            <div id="bans" class="tab-pane fade">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Banned Endpoints</h5>
                    </div>
                    <div class="card-body">
                        <div v-if="bans.length === 0" class="empty-state">
                            No banned endpoints
                        </div>
                        <table v-else class="table table-sm">
                            <thead>
                                <tr>
                                    <th>IP:Port</th>
                                    <th>Player</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="ban in bans" :key="ban.ip">
                                    <td><code>{{ ban.ip }}:{{ ban.port }}</code></td>
                                    <td>{{ ban.playerName || 'Unknown' }}</td>
                                    <td>{{ ban.reason || 'No reason' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" @click="unban(ban.ip, ban.port)">Unban</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Lobby Modal -->
<div class="modal fade" id="createLobbyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Lobby</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Difficulty</label>
                    <select v-model="newLobby.difficulty" class="form-select">
                        <option value="Easy">Easy</option>
                        <option value="Normal">Normal</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>
                <!-- Public lobby option temporarily disabled -->
                <!--
                <div class="mb-3">
                    <label class="form-check-label">
                        <input v-model="newLobby.isPublic" type="checkbox" class="form-check-input">
                        Public Lobby
                    </label>
                </div>
                -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" @click="createLobby" data-bs-dismiss="modal">Create</button>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const { createApp } = Vue;

let playerChart = null;
let packetRxChart = null;
let packetLossChart = null;
let tickOverrunsChart = null;

createApp({
    data() {
        return {
            loading: true,
            serverOnline: false,
            metrics: {
                playerCount: 0,
                uptime: 0,
                packetsReceived: 0,
                packetsSent: 0,
                packetsDropped: 0,
                bytesReceived: 0,
                bytesSent: 0,
                tickOverruns: 0,
                connectionsRejected: 0,
                totalConnections: 0,
                history: []
            },
            lobbies: [],
            players: [],
            bans: [],
            newLobby: {
                difficulty: 'Normal',
                isPublic: true
            }
        };
    },
    methods: {
        async fetchMetrics() {
            try {
                const res = await fetch('/api/metrics');
                if (res.status === 401) {
                    console.error('Unauthorized - incorrect token or not localhost');
                    alert('Unauthorized - incorrect token or not localhost');
                    return;
                }
                if (!res.ok) {
                    console.error('Failed to fetch metrics, status:', res.status);
                    this.serverOnline = false;
                    return;
                }
                const data = await res.json();
                console.log('Metrics fetched:', data);
                this.metrics = data;
                this.serverOnline = true;
                this.loading = false;
                this.updateCharts();
            } catch (e) {
                this.serverOnline = false;
                this.loading = false;
                console.error('Failed to fetch metrics:', e);
            }
        },
        async fetchLobbies() {
            try {
                const res = await fetch('/api/lobbies');
                if (res.ok) {
                    const data = await res.json();
                    this.lobbies = data.lobbies || [];
                }
            } catch (e) {
                console.error('Failed to fetch lobbies:', e);
            }
        },
        async fetchPlayers() {
            try {
                const res = await fetch('/api/players');
                if (res.ok) {
                    const data = await res.json();
                    this.players = data.players || [];
                }
            } catch (e) {
                console.error('Failed to fetch players:', e);
            }
        },
        async fetchBans() {
            try {
                const res = await fetch('/api/bans');
                if (res.ok) {
                    const data = await res.json();
                    this.bans = data.bans || [];
                }
            } catch (e) {
                console.error('Failed to fetch bans:', e);
            }
        },
        async resetMetrics() {
            if (!confirm('Reset all metrics history?')) return;
            try {
                await fetch('/api/metrics/reset', {method: 'POST'});
                await this.fetchMetrics();
            } catch (e) {
                alert('Failed to reset metrics');
            }
        },
        async createLobby() {
            try {
                const lobbyData = {
                    difficulty: this.newLobby.difficulty,
                    isPublic: false
                };
                const res = await fetch('/api/lobby/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(lobbyData)
                });
                if (res.ok) {
                    await this.fetchLobbies();
                } else {
                    alert('Failed to create lobby');
                }
            } catch (e) {
                alert('Failed to create lobby: ' + e.message);
            }
        },
        async deleteLobby(code) {
            if (!confirm(`Delete lobby ${code}?`)) return;
            try {
                const res = await fetch(`/api/lobby/${code}/delete`, {method: 'POST'});
                if (res.ok) {
                    await this.fetchLobbies();
                } else {
                    alert('Failed to delete lobby');
                }
            } catch (e) {
                alert('Failed to delete lobby: ' + e.message);
            }
        },
        async kickPlayer(id) {
            if (!confirm(`Kick player #${id}?`)) return;
            try {
                const res = await fetch(`/api/kick/${id}`, {method: 'POST'});
                if (res.ok) {
                    await this.fetchPlayers();
                } else {
                    alert('Failed to kick player');
                }
            } catch (e) {
                alert('Failed to kick player: ' + e.message);
            }
        },
        async banPlayer(player) {
            const reason = prompt(`Enter ban reason for player #${player.id} (IP ${player.ip}):`, 'Violation of server rules');
            if (reason === null) return;
            try {
                const res = await fetch('/api/ban', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ip: player.ip, reason: reason })
                });
                if (res.ok) {
                    await this.fetchBans();
                    await this.fetchPlayers();
                } else {
                    const err = await res.text();
                    alert('Failed to ban player: ' + err);
                }
            } catch (e) {
                alert('Failed to ban player: ' + e.message);
            }
        },
        async unban(ip, port) {
            if (!confirm(`Unban ${ip}:${port}?`)) return;
            try {
                const res = await fetch('/api/unban', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ip, port})
                });
                if (res.ok) {
                    await this.fetchBans();
                } else {
                    alert('Failed to unban');
                }
            } catch (e) {
                alert('Failed to unban: ' + e.message);
            }
        },
        formatTime(seconds) {
            const d = new Date(seconds * 1000);
            return d.toLocaleTimeString();
        },
        updateCharts() {
            if (!this.metrics.history || this.metrics.history.length === 0) return;

            const labels = this.metrics.history.map((_, i) => i);
            const playerCounts = this.metrics.history.map(h => h.playerCount);
            const packetLoss = this.metrics.history.map(h => h.packetLossPercent);

            if (!playerChart) {
                const ctx = document.getElementById('playerChart');
                if (ctx) {
                    playerChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Players',
                                data: playerCounts,
                                borderColor: '#e94560',
                                backgroundColor: 'rgba(233, 69, 96, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {beginAtZero: true, max: 4}
                            }
                        }
                    });
                }
            } else {
                playerChart.data.labels = labels;
                playerChart.data.datasets[0].data = playerCounts;
                playerChart.update();
            }

            const packetRx = this.metrics.history.map(h => h.packetsReceived || 0);
            if (!packetRxChart) {
                const ctx = document.getElementById('packetRxChart');
                if (ctx) {
                    packetRxChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Packets RX',
                                data: packetRx,
                                borderColor: '#4ecdc4',
                                backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {beginAtZero: true}
                            }
                        }
                    });
                }
            } else {
                packetRxChart.data.labels = labels;
                packetRxChart.data.datasets[0].data = packetRx;
                packetRxChart.update();
            }

            if (!packetLossChart) {
                const ctx = document.getElementById('packetLossChart');
                if (ctx) {
                    packetLossChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Packet Loss %',
                                data: packetLoss,
                                borderColor: '#ff6b6b',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {beginAtZero: true, max: 100}
                            }
                        }
                    });
                }
            } else {
                packetLossChart.data.labels = labels;
                packetLossChart.data.datasets[0].data = packetLoss;
                packetLossChart.update();
            }

            const tickOverruns = this.metrics.history.map(h => h.tickOverruns || 0);
            if (!tickOverrunsChart) {
                const ctx = document.getElementById('tickOverrunsChart');
                if (ctx) {
                    tickOverrunsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Tick Overruns',
                                data: tickOverruns,
                                borderColor: '#f39c12',
                                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {beginAtZero: true}
                            }
                        }
                    });
                }
            } else {
                tickOverrunsChart.data.labels = labels;
                tickOverrunsChart.data.datasets[0].data = tickOverruns;
                tickOverrunsChart.update();
            }
        },
        pollData() {
            this.fetchMetrics();
            this.fetchLobbies();
            this.fetchPlayers();
            this.fetchBans();
        }
    },
    mounted() {
        this.pollData();
        setInterval(() => this.pollData(), 1000);
    }
}).mount('#app');
</script>
</body>
</html>
